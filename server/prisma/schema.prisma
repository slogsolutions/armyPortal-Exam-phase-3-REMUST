generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Admin {
  id       Int    @id @default(autoincrement())
  username String @unique
  password String
  role     String
}

model Rank {
  id   Int    @id @default(autoincrement())
  name String @unique

  candidates Candidate[]
}

model Command {
  id   Int    @id @default(autoincrement())
  name String @unique

  candidates Candidate[]
  centers    ConductingCenter[]
  examSlots  ExamSlot[]
}

model ConductingCenter {
  id        Int    @id @default(autoincrement())
  name      String
  commandId Int

  command   Command @relation(fields: [commandId], references: [id])
  candidates Candidate[]
  examSlots  ExamSlot[]

  @@unique([commandId, name])
}

model Trade {
  id   Int    @id @default(autoincrement())
  name String @unique
  negativeMarking Float?
  defaultTime Int    // Default exam time in minutes
  totalQuestions Int  // Total number of questions
  totalMarks Float    // Total marks for the exam
  wp1 Boolean @default(false)
  wp2 Boolean @default(false)
  wp3 Boolean @default(false)
  pr1 Boolean @default(false)
  pr2 Boolean @default(false)
  pr3 Boolean @default(false)
  pr4 Boolean @default(false)
  pr5 Boolean @default(false)
  oral Boolean @default(false)

  candidates Candidate[]
  examPapers ExamPaper[]
  examSlots ExamSlot[]
}

model Candidate {
  id     Int    @id @default(autoincrement())
  armyNo String @unique
  name   String
  unit   String
  medCat String
  corps  String

  dob DateTime
  doe DateTime

  selectedExamTypes String  // JSON array of selected exam types: ["WP-I", "WP-II", "WP-III"]

  rankId    Int
  tradeId   Int
  commandId Int
  centerId  Int?

  rank    Rank             @relation(fields: [rankId], references: [id])
  trade   Trade            @relation(fields: [tradeId], references: [id])
  command Command          @relation(fields: [commandId], references: [id])
  center  ConductingCenter? @relation(fields: [centerId], references: [id])

  examAttempts ExamAttempt[]
  practicalMarks PracticalMarks?
  examSlots    ExamSlot[]
}

model ExamPaper {
  id        Int      @id @default(autoincrement())
  tradeId   Int
  paperType String   // WP-I, WP-II, WP-III (only written papers)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  trade      Trade       @relation(fields: [tradeId], references: [id])
  questions  Question[]
  examAttempts ExamAttempt[]

  @@unique([tradeId, paperType])
}

model Question {
  id            Int       @id @default(autoincrement())
  examPaperId   Int
  questionText  String    @db.Text
  optionA       String?
  optionB       String?
  optionC       String?
  optionD       String?
  correctAnswer String    // A, B, C, or D
  marks         Float     @default(1.0)
  questionOrder Int
  createdAt     DateTime  @default(now())

  examPaper ExamPaper @relation(fields: [examPaperId], references: [id], onDelete: Cascade)
  answers   Answer[]
}

model ExamAttempt {
  id          Int       @id @default(autoincrement())
  candidateId Int
  examPaperId Int
  examSlotId  Int?
  score       Float     @default(0)
  totalMarks  Float     @default(0)
  percentage  Float     @default(0)
  status      String    @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED
  startedAt   DateTime?
  submittedAt DateTime?
  createdAt   DateTime  @default(now())

  candidate Candidate @relation(fields: [candidateId], references: [id])
  examPaper ExamPaper @relation(fields: [examPaperId], references: [id])
  examSlot  ExamSlot?  @relation(fields: [examSlotId], references: [id])
  answers   Answer[]
}

model Answer {
  id            Int    @id @default(autoincrement())
  examAttemptId Int
  questionId    Int
  selectedAnswer String // A, B, C, or D
  isCorrect     Boolean
  marksObtained Float
  createdAt     DateTime @default(now())

  examAttempt ExamAttempt @relation(fields: [examAttemptId], references: [id], onDelete: Cascade)
  question    Question    @relation(fields: [questionId], references: [id])
}

model PracticalMarks {
  id          Int       @id @default(autoincrement())
  candidateId Int       @unique
  pr1         Float?
  pr2         Float?
  pr3         Float?
  pr4         Float?
  pr5         Float?
  oral        Float?
  enteredBy   Int       // Admin ID who entered the marks
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
}

model ExamSlot {
  id          Int       @id @default(autoincrement())
  tradeId     Int
  paperType   String    // WP-I, WP-II, WP-III, PR-I, PR-II, PR-III, PR-IV, PR-V, ORAL
  startTime   DateTime
  endTime     DateTime
  commandId   Int
  centerId    Int
  currentCount Int      @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  trade     Trade       @relation(fields: [tradeId], references: [id])
  command   Command     @relation(fields: [commandId], references: [id])
  center    ConductingCenter @relation(fields: [centerId], references: [id])
  candidates Candidate[]
  examAttempts ExamAttempt[]

  @@unique([tradeId, paperType, startTime])
}
